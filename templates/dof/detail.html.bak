{% extends "layout.html" %}

{% block title %}DÖF Detayı - DÖF Yönetim Sistemi{% endblock %}

{% block content %}
<div class="d-flex justify-content-between mb-4">
    <h1 class="h3">DÖF Detayı</h1>
    <div class="d-flex align-items-center">
        <a href="{{ url_for('dof.list_dofs') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> DÖF Listesine Dön
        </a>

        <!-- İlk inceleme butonu: Taslak veya gönderildi durumundaki DÖF'ler için (sadece Kalite ve Admin) -->
        {% if current_user.role in [0, 2] and dof.status in [0, 1, 2] %}
        <a href="{{ url_for('dof.review_dof', dof_id=dof.id) }}" class="btn btn-primary ms-2 btn-lg">
            <i class="fas fa-search me-1"></i> İncele ve Ata
        </a>
        {% endif %}
        
        <!-- Son değerlendirme butonu: Çözüldü durumundaki DÖF'ler için (sadece Kalite ve Admin) -->
        {% if current_user.role in [0, 2] and dof.status == 5 %}
        <a href="{{ url_for('dof.close_dof', dof_id=dof.id) }}" class="btn btn-success ms-2 btn-lg">
            <i class="fas fa-check-double me-1"></i> Çözümü Değerlendir ve Kapat 
        </a>
        {% endif %}

        <!-- Çözüm Planı Gir butonu: Sadece departman yöneticileri (rol 4) ve adminler, hem de çözüm planı girilmemişse -->
        {% if (current_user.role == 4 or current_user.role == 0) and (not dof.root_cause1 or not dof.action_plan) and 
              ((current_user.role == 4 and dof.department and current_user.department and current_user.department.id == dof.department.id and dof.created_by != current_user.id) or current_user.role == 0) %}
        <a href="{{ url_for('dof.resolve_dof', dof_id=dof.id) }}" class="btn btn-success ms-2 btn-lg">
            <i class="fas fa-clipboard-check me-1"></i> Çözüm Planı Gir
        </a>
        {% endif %}
        
        <!-- Çözüldü olarak işaretle butonu - Departman yöneticileri için (kaynak ve atanan departmanlar) -->
        {% if dof.status == 4 and ((current_user.role == 4 and dof.department and current_user.department and current_user.department.id == dof.department.id) or 
                                  (current_user.role == 4 and current_user.department and current_user.department.id == dof.creator.department_id) or
                                  current_user.role == 0) %}
        <form method="POST" action="{{ url_for('dof.add_dof_action', dof_id=dof.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="comment" value="DÖF '{% if current_user.department %}{{ current_user.department.name }}{% else %}Admin{% endif %}' departmanı tarafından Çözüldü olarak işaretlendi.">
            <input type="hidden" name="new_status" value="5"> <!-- 5: Çözüldü -->
        </div>
    </div>
    
    <!-- İşlem butonları -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body py-3">
                    <div class="d-flex flex-wrap">
                        <!-- Genel butonlar -->
                        <div class="me-2 mb-2">
                            <a href="{{ url_for('dof.list_dofs') }}" class="btn btn-light border-secondary btn-sm" title="DÖF Listesi">
                                <i class="fas fa-list"></i>
                                <span class="d-none d-sm-inline-block ms-1">DÖF Listesine Dön</span>
                            </a>
                        </div>
                        
                        {% if can_edit %}
                        <div class="me-2 mb-2">
                            <a href="{{ url_for('dof.edit_dof', dof_id=dof.id) }}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-edit"></i>
                                <span class="ms-1">Düzenle</span>
                            </a>
                        </div>
                        {% endif %}
                        
                        <!-- Kalite departmanı için butonlar -->
                        {% if current_user.is_quality_manager() or current_user.is_admin() %}
                            {% if dof.status == 1 or dof.status == 2 %}
                            <div class="me-2 mb-2">
                                <a href="{{ url_for('dof.review_dof', dof_id=dof.id) }}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-clipboard-check"></i>
                                    <span class="ms-1">DÖF'u İncele</span>
                                </a>
                            </div>
                            {% endif %}
                            
                            {% if dof.status == 8 %}
                            <div class="me-2 mb-2">
                                <a href="{{ url_for('dof.review_dof', dof_id=dof.id) }}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-project-diagram"></i>
                                    <span class="ms-1">Aksiyon Planını İncele</span>
                                </a>
                            </div>
                            {% endif %}
                            
                            {% if dof.status == 5 %}
                            <div class="me-2 mb-2">
                                <a href="{{ url_for('dof.close_dof', dof_id=dof.id) }}" class="btn btn-success btn-sm">
                                    <i class="fas fa-check-double"></i>
                                    <span class="ms-1">Çözümü Değerlendir</span>
                                </a>
                            </div>
                            {% endif %}
                        {% endif %}
                        
                        <!-- Atanan departman butonları -->
                        {% if current_user.department_id == dof.department_id and current_user.is_department_manager() %}
                            {% if dof.status == 3 %}
                            <div class="me-2 mb-2">
                                <a href="{{ url_for('dof.resolve_dof', dof_id=dof.id) }}" class="btn btn-warning btn-sm">
                                    <i class="fas fa-file-alt"></i>
                                    <span class="ms-1">Kök Neden ve Aksiyon Planı Gir</span>
                                </a>
                            </div>
                            {% endif %}
                            
                            {% if dof.status == 9 %}
                            <div class="me-2 mb-2">
                                <a href="{{ url_for('dof.resolve_dof', dof_id=dof.id) }}" class="btn btn-success btn-sm">
                                    <i class="fas fa-check"></i>
                                    <span class="ms-1">Tamamlandı Olarak İşaretle</span>
                                </a>
                            </div>
                            {% endif %}
                        {% endif %}
                        
                        <!-- Kaynak departman butonları -->
                        {% if current_user.department_id == dof.source_department_id and current_user.is_department_manager() %}
                            {% if dof.status == 10 %}
                            <div class="me-2 mb-2">
                                <a href="{{ url_for('dof.review_source', dof_id=dof.id) }}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-search"></i>
                                    <span class="ms-1">Tamamlanan Aksiyonları İncele</span>
                                </a>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- İş Akışı Bilgilendirmeleri -->
{% if dof.status == 0 %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle me-2"></i> Bu DÖF Kalite onayındadır. Kalite departmanı tarafından değerlendirilecektir.
</div>
{% elif dof.status == 1 %}
<div class="alert alert-warning mb-4">
    <i class="fas fa-hourglass-half me-1"></i> Bu DÖF Kalite Departmanı tarafından değerlendirilmeyi bekliyor.
</div>
{% elif dof.status == 2 %}
<div class="alert alert-primary mb-4">
    <i class="fas fa-spinner me-1"></i> Bu DÖF şu anda kalite departmanı tarafından inceleniyor.
</div>
{% elif dof.status == 3 %}
<div class="alert alert-secondary mb-4">
    <i class="fas fa-people-arrows me-1"></i> Bu DÖF {{ dof.department.name }} departmanına atandı. Kök neden analizi ve aksiyon planının oluşturulması bekleniyor.
</div>
{% elif dof.status == 8 %}
<div class="alert alert-warning mb-4">
    <i class="fas fa-project-diagram me-1"></i> Kök neden analizi ve aksiyon planı hazırlandı. Kalite departmanı tarafından inceleme bekleniyor.
</div>
{% elif dof.status == 9 %}
<div class="alert alert-info mb-4">
    <i class="fas fa-cogs me-1"></i> Aksiyon planı onaylanmış ve uygulama aşamasında. Sorumlu departman: {{ dof.department.name }}
</div>
{% elif dof.status == 10 %}
<div class="alert alert-success mb-4">
    <i class="fas fa-check me-1"></i> Aksiyon planları tamamlandı. Kaynak departmanın onayı bekleniyor.
</div>
{% elif dof.status == 11 %}
<div class="alert alert-info mb-4">
    <i class="fas fa-search me-1"></i> Kaynak departman tarafından inceleme aşamasında. 
</div>
{% elif dof.status == 5 %}
<div class="alert alert-success mb-4">
    <i class="fas fa-check me-1"></i> Bu DÖF çözüldü. Kalite departmanı tarafından son inceleme bekleniyor.
</div>
{% elif dof.status == 6 %}
<div class="alert alert-success mb-4">
    <i class="fas fa-check-double me-1"></i> Bu DÖF başarıyla tamamlandı ve kapatıldı.
</div>
{% elif dof.status == 7 %}
<div class="alert alert-danger mb-4">
    <i class="fas fa-times-circle me-1"></i> Bu DÖF reddedildi.
</div>
{% elif dof.status == 4 %}
<div class="alert alert-warning mb-4">
    <i class="fas fa-exclamation-triangle me-1"></i> Bu DÖF üzerinde yeniden çalışma gerekiyor. Sorumlu departman: {{ dof.department.name }}
</div>
{% endif %}

<!-- DÖF Detay Kartı -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <span class="badge bg-primary me-2">#{{ dof.id }}</span> {{ dof.title }}
            </h5>
            <div>
                {% if dof.status == 0 %}
                    <span class="badge bg-secondary">Taslak</span>
                {% elif dof.status == 1 %}
                    <span class="badge bg-info">Gönderildi</span>
                {% elif dof.status == 2 %}
                    <span class="badge bg-primary">İncelemede</span>
                {% elif dof.status == 3 %}
                    <span class="badge bg-warning">Atandı</span>
                {% elif dof.status == 4 %}
                    <span class="badge bg-info">Devam Ediyor</span>
                    <span class="ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="DÖF'ü çözüldü olarak işaretlemek için, hem kaynak hem atanan departman yöneticileri onaylamalıdır."><i class="fas fa-info-circle text-primary"></i></span>
                {% elif dof.status == 5 %}
                    <span class="badge bg-success">Çözüldü</span>
                {% elif dof.status == 6 %}
                    <span class="badge bg-secondary">Kapatıldı</span>
                {% elif dof.status == 7 %}
                    <span class="badge bg-danger">Reddedildi</span>
                {% elif dof.status == 8 %}
                    <span class="badge bg-warning">Planlama</span>
                {% elif dof.status == 9 %}
                    <span class="badge bg-info">Uygulama Aşaması</span>
                {% elif dof.status == 10 %}
                    <span class="badge bg-success">Tamamlandı</span>
                {% elif dof.status == 11 %}
                    <span class="badge bg-primary">Kaynak İncelemesi</span>
                {% endif %}
                
                {% if dof.priority == 1 %}
                    <span class="badge bg-success ms-1">Düşük Öncelik</span>
                {% elif dof.priority == 2 %}
                    <span class="badge bg-warning ms-1">Orta Öncelik</span>
                {% elif dof.priority == 3 %}
                    <span class="badge bg-danger ms-1">Yüksek Öncelik</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6 class="mb-3">DÖF Bilgileri</h6>
                <table class="table table-borderless table-sm">
                    <tr>
                        <td class="fw-bold">Tip:</td>
                        <td>{{ dof.type_name }}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Kaynak:</td>
                        <td>{{ dof.source_name }}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Durum:</td>
                        <td>
                            <span class="badge
                                {% if dof.status == 0 %}bg-secondary
                                {% elif dof.status == 1 %}bg-info
                                {% elif dof.status == 2 %}bg-primary
                                {% elif dof.status == 3 %}bg-warning
                                {% elif dof.status == 4 %}bg-info
                                {% elif dof.status == 5 %}bg-success
                                {% elif dof.status == 6 %}bg-dark
                                {% elif dof.status == 7 %}bg-danger
                                {% endif %}">
                                {{ dof.status_name }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Kaynak Departman:</td>
                        <td>{{ dof.creator.department.name }} ({{ dof.creator.first_name }} {{ dof.creator.last_name }})</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Atanan Departman:</td>
                        <td>{% if dof.department %}<strong class="text-success">{{ dof.department.name }}</strong>{% else %}<span class="text-warning">Departman Atanmadı</span>{% endif %}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="mb-3">Tarihler</h6>
                <table class="table table-borderless table-sm">
                    <tr>
                        <td class="fw-bold">Oluşturulma:</td>
                        <td>{{ dof.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Son Güncelleme:</td>
                        <td>{{ dof.updated_at.strftime('%d.%m.%Y %H:%M') }}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Termin Tarihi:</td>
                        <td>{% if dof.due_date %}{{ dof.due_date.strftime('%d.%m.%Y') }}{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Kapatılma Tarihi:</td>
                        <td>{% if dof.closed_at %}{{ dof.closed_at.strftime('%d.%m.%Y %H:%M') }}{% else %}-{% endif %}</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h6 class="mb-3">Açıklama</h6>
                <div class="p-3 bg-light rounded">
                    {{ dof.description|nl2br|safe }}
                </div>
            </div>
        </div>

        {% if dof.status >= 3 %}
        <!-- Kök Neden Analizi ve Aksiyon Planı Bölümü - Sadece atandıktan sonra görünür -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">Kök Neden Analizi</h6>
                    </div>
                    <div class="card-body">
                        {% if dof.root_cause1 or dof.root_cause2 or dof.root_cause3 %}
                            {% if dof.root_cause1 %}
                            <div class="mb-3">
                                <label class="fw-bold">1. Kök Neden:</label>
                                <div class="p-2 bg-light rounded">{{ dof.root_cause1|nl2br|safe }}</div>
                            </div>
                            {% endif %}
                            {% if dof.root_cause2 %}
                            <div class="mb-3">
                                <label class="fw-bold">2. Kök Neden:</label>
                                <div class="p-2 bg-light rounded">{{ dof.root_cause2|nl2br|safe }}</div>
                            </div>
                            {% endif %}
                            {% if dof.root_cause3 %}
                            <div class="mb-3">
                                <label class="fw-bold">3. Kök Neden:</label>
                                <div class="p-2 bg-light rounded">{{ dof.root_cause3|nl2br|safe }}</div>
                            </div>
                            {% endif %}
                            {% if dof.root_cause4 %}
                            <div class="mb-3">
                                <label class="fw-bold">4. Kök Neden:</label>
                                <div class="p-2 bg-light rounded">{{ dof.root_cause4|nl2br|safe }}</div>
                            </div>
                            {% endif %}
                            {% if dof.root_cause5 %}
                            <div class="mb-3">
                                <label class="fw-bold">5. Kök Neden:</label>
                                <div class="p-2 bg-light rounded">{{ dof.root_cause5|nl2br|safe }}</div>
                            </div>
                            {% endif %}
                        {% else %}
                            {% if dof.status >= 3 and dof.status < 5 and current_user.role == 3 and current_user.department_id == dof.department_id %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i> Henüz kök neden analizi girilmemiş. 
                                    <a href="{{ url_for('dof.resolve_dof', dof_id=dof.id) }}" class="alert-link">Kök neden analizi eklemek için tıklayın</a>.
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> Henüz kök neden analizi girilmemiş.
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">Aksiyon Planı</h6>
                    </div>
                    <div class="card-body">
                        {% if dof.action_plan %}
                            <div class="mb-3">
                                <div class="p-3 bg-light rounded">{{ dof.action_plan|nl2br|safe }}</div>
                            </div>
                            {% if dof.deadline %}
                            <div class="mb-3">
                                <label class="fw-bold">Termin Tarihi:</label>
                                <span class="ms-2 badge bg-info">{{ dof.deadline.strftime('%d.%m.%Y') }}</span>
                            </div>
                            {% endif %}
                        {% else %}
                            {% if dof.status >= 3 and dof.status < 5 and current_user.role == 3 and current_user.department_id == dof.department_id %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i> Henüz aksiyon planı girilmemiş. 
                                    <a href="{{ url_for('dof.resolve_dof', dof_id=dof.id) }}" class="alert-link">Aksiyon planı eklemek için tıklayın</a>.
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> Henüz aksiyon planı girilmemiş.
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- İki Sütunlu İçerik -->
<div class="row">
    <!-- Aksiyon Formu ve Dosya Ekleri -->
    <div class="col-md-7">
        {% if dof.status not in [6, 7] and can_edit %}
        <!-- Aksiyon Formu -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">Aksiyon Ekle</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('dof.add_dof_action', dof_id=dof.id) }}" class="needs-validation" enctype="multipart/form-data" novalidate>
                    {{ form.csrf_token }}
                    
                    <div class="mb-3">
                        <label for="{{ form.comment.id }}" class="form-label required-field">{{ form.comment.label }}</label>
                        {{ form.comment(class="form-control", rows=3, required=true) }}
                        <div class="invalid-feedback">
                            Yorum alanı gereklidir
                        </div>
                        {% if form.comment.errors %}
                            <div class="text-danger">
                                {% for error in form.comment.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Atanan departman için kök neden ve aksiyon planları alanları -->
                    {% if dof.status == 3 and current_user.department_id == dof.department_id %}
                    <div class="mb-3">
                        <label for="{{ form.root_cause.id }}" class="form-label required-field">{{ form.root_cause.label }}</label>
                        {{ form.root_cause(class="form-control", rows=4, required=true) }}
                        <div class="invalid-feedback">
                            Kök neden analizi gereklidir
                        </div>
                        {% if form.root_cause.errors %}
                            <div class="text-danger">
                                {% for error in form.root_cause.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">Lütfen oluşan uygunsuzluğun/sorunun kök nedenini analiz ediniz. Ne, ne zaman, nerede, kim tarafından, nasıl, neden sorularını cevaplayınız.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.resolution_plan.id }}" class="form-label required-field">{{ form.resolution_plan.label }}</label>
                        {{ form.resolution_plan(class="form-control", rows=4, required=true) }}
                        <div class="invalid-feedback">
                            Aksiyon planı gereklidir
                        </div>
                        {% if form.resolution_plan.errors %}
                            <div class="text-danger">
                                {% for error in form.resolution_plan.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">Lütfen bu sorunu çözmek için yapılacak aksiyonları adım adım belirtiniz.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.deadline.id }}" class="form-label required-field">{{ form.deadline.label }}</label>
                        {{ form.deadline(class="form-control", type="date", required=true) }}
                        <div class="invalid-feedback">
                            Termin tarihi gereklidir
                        </div>
                        {% if form.deadline.errors %}
                            <div class="text-danger">
                                {% for error in form.deadline.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if form.new_status.choices %}
                    <div class="mb-3">
                        <label for="{{ form.new_status.id }}" class="form-label">{{ form.new_status.label }}</label>
                        {{ form.new_status(class="form-control select2") }}
                        {% if form.new_status.errors %}
                            <div class="text-danger">
                                {% for error in form.new_status.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="{{ form.assigned_to.id }}" class="form-label">{{ form.assigned_to.label }}</label>
                        {{ form.assigned_to(class="form-control select2") }}
                        {% if form.assigned_to.errors %}
                            <div class="text-danger">
                                {% for error in form.assigned_to.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.files.id }}" class="form-label">{{ form.files.label }}</label>
                        {{ form.files(class="form-control", multiple=true) }}
                        <small class="form-text text-muted">İzin verilen dosya tipleri: PDF, PNG, JPG, DOC, DOCX, XLS, XLSX (Max: 16MB)</small>
                        {% if form.files.errors %}
                            <div class="text-danger">
                                {% for error in form.files.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
        
        <!-- Dosya Ekleri -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">Dosya Ekleri</h5>
            </div>
            <div class="card-body">
                {% if attachments %}
                <ul class="attachment-list">
                    {% for attachment in attachments %}
                    <li class="attachment-item">
                        {% if attachment.file_type == 'pdf' %}
                        <i class="far fa-file-pdf text-danger"></i>
                        {% elif attachment.file_type in ['doc', 'docx'] %}
                        <i class="far fa-file-word text-primary"></i>
                        {% elif attachment.file_type in ['xls', 'xlsx'] %}
                        <i class="far fa-file-excel text-success"></i>
                        {% elif attachment.file_type in ['jpg', 'jpeg', 'png'] %}
                        <i class="far fa-file-image text-info"></i>
                        {% else %}
                        <i class="far fa-file text-secondary"></i>
                        {% endif %}
                        
                        <span class="me-auto">{{ attachment.filename }}</span>
                        <small class="text-muted me-3">
                            {{ (attachment.file_size / 1024)|round(1) }} KB
                        </small>
                        <a href="{{ url_for('dof.download_attachment', dof_id=dof.id, attachment_id=attachment.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download"></i>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-center text-muted mb-0">Henüz dosya eki bulunmamaktadır</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Aksiyon Zaman Çizelgesi -->
    <div class="col-md-5">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">Aksiyon Geçmişi</h5>
            </div>
            <div class="card-body p-0">
                <div class="timeline p-3">
                    {% if actions %}
                        {% for action in actions %}
                        <div class="timeline-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <b>{{ action.user.first_name }} {{ action.user.last_name }}</b>
                                    {% if action.action_type == 1 %}
                                    <span class="text-muted">yorum ekledi</span>
                                    {% elif action.action_type == 2 %}
                                    <span class="text-muted">DÖF'ü güncelledi</span>
                                    {% elif action.action_type == 3 %}
                                    <span class="text-muted">durumu değiştirdi</span>
                                    {% endif %}
                                </div>
                                <span class="timeline-date">{{ action.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                            </div>
                            
                            {% if action.action_type == 3 %}
                            <div class="mt-2 mb-3">
                                <span class="badge bg-secondary">
                                    {% if action.old_status == 0 %}Taslak{% endif %}
                                    {% if action.old_status == 1 %}Gönderildi{% endif %}
                                    {% if action.old_status == 2 %}İncelemede{% endif %}
                                    {% if action.old_status == 3 %}Atandı{% endif %}
                                    {% if action.old_status == 4 %}Devam Ediyor{% endif %}
                                    {% if action.old_status == 5 %}Çözüldü{% endif %}
                                    {% if action.old_status == 6 %}Kapatıldı{% endif %}
                                    {% if action.old_status == 7 %}Reddedildi{% endif %}
                                    {% if action.old_status == 8 %}Planlama{% endif %}
                                    {% if action.old_status == 9 %}Uygulama Aşaması{% endif %}
                                    {% if action.old_status == 10 %}Tamamlandı{% endif %}
                                    {% if action.old_status == 11 %}Kaynak İncelemesi{% endif %}
                                </span>
                                <i class="fas fa-arrow-right mx-2"></i>
                                <span class="badge bg-primary">
                                    {% if action.new_status == 0 %}Taslak{% endif %}
                                    {% if action.new_status == 1 %}Gönderildi{% endif %}
                                    {% if action.new_status == 2 %}İncelemede{% endif %}
                                    {% if action.new_status == 3 %}Atandı{% endif %}
                                    {% if action.new_status == 4 %}Devam Ediyor{% endif %}
                                    {% if action.new_status == 5 %}Çözüldü{% endif %}
                                    {% if action.new_status == 6 %}Kapatıldı{% endif %}
                                    {% if action.new_status == 7 %}Reddedildi{% endif %}
                                    {% if action.new_status == 8 %}Planlama{% endif %}
                                    {% if action.new_status == 9 %}Uygulama Aşaması{% endif %}
                                    {% if action.new_status == 10 %}Tamamlandı{% endif %}
                                    {% if action.new_status == 11 %}Kaynak İncelemesi{% endif %}
                                </span>
                            </div>
                            {% endif %}
                            
                            <div class="p-3 bg-light rounded mt-2">
                                {{ action.comment|nl2br }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-muted py-4">Henüz aksiyon bulunmamaktadır.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // jQuery yüklendikten sonra çalışacak
        if (typeof $ !== 'undefined') {
            // Select2 initialize
            $('.select2').select2({
                theme: 'bootstrap4',
                language: 'tr',
                width: '100%'
            });
        }
    });
</script>
{% endblock %}

{% endblock content %}
