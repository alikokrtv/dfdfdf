{% extends "layout.html" %}

{% block title %}DÖF Detayı - DÖF Yönetim Sistemi{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/process-bar.css') }}">
<style>
    @media print {
        /* Sadece ana içerik göster, sidebar ve menüler gizle */
        .navbar, .sidebar, .main-sidebar, .content-wrapper .sidebar, 
        .main-header, .main-footer, .dropdown, .btn-group,
        .pagination, .breadcrumb, nav { display: none !important; }
        
        /* Print sayfası düzeni */
        body { 
            font-family: Arial, sans-serif; 
            font-size: 12px; 
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Print container */
        .container-fluid, .container {
            margin: 0 !important;
            padding: 0 !important;
            max-width: none !important;
            width: 100% !important;
        }
        
        /* Butonları ve interaktif elementleri gizle */
        .btn, .dropdown, .modal, .dropdown-toggle, 
        button, input[type="submit"], input[type="button"] { 
            display: none !important; 
        }
        
        /* Kartları düzenle */
        .card { 
            border: 1px solid #dee2e6 !important; 
            margin-bottom: 1rem !important; 
            page-break-inside: avoid;
        }
        
        /* Badge'leri yazdırılabilir yap */
        .badge { 
            background-color: #f8f9fa !important; 
            color: #495057 !important; 
            border: 1px solid #dee2e6 !important; 
            padding: 4px 8px !important;
        }
        
        /* Arka plan renklerini yazdırılabilir yap */
        .bg-light { background-color: #f8f9fa !important; }
        .bg-primary { background-color: #007bff !important; color: white !important; }
        .bg-success { background-color: #28a745 !important; color: white !important; }
        .bg-warning { background-color: #ffc107 !important; color: black !important; }
        .bg-danger { background-color: #dc3545 !important; color: white !important; }
        .bg-info { background-color: #17a2b8 !important; color: white !important; }
        
        /* Tabloları düzenle */
        .table { border-collapse: collapse !important; }
        .table th, .table td { 
            border: 1px solid #dee2e6 !important; 
            padding: 8px !important; 
        }
        
        /* Alert'leri düzenle */
        .alert { 
            border: 1px solid #dee2e6 !important; 
            padding: 10px !important; 
            page-break-inside: avoid;
        }
        
        /* Progress bar'ı düzenle */
        .progress-container { margin-bottom: 20px !important; }
        .progressbar { 
            display: flex !important; 
            list-style: none !important; 
            padding: 0 !important; 
        }
        .progressbar li { 
            flex: 1 !important; 
            text-align: center !important; 
            padding: 10px !important; 
            border: 1px solid #dee2e6 !important; 
            font-size: 11px !important;
        }
        .progressbar li.active { 
            background-color: #28a745 !important; 
            color: white !important; 
        }
        .progressbar li.current { 
            background-color: #007bff !important; 
            color: white !important; 
        }
        
        /* Sayfa ayarları */
        @page { 
            margin: 0.75in; 
            size: A4;
        }
        
        /* Sayfa kırılmalarını kontrol et */
        h1, h2, h3, h4, h5, h6 {
            page-break-after: avoid;
        }
        
        /* İkonları gizle (yazdırma sırasında bozuk görünebilir) */
        .fas, .far, .fab { display: none !important; }
        
        /* Print-only başlık ekle */
        body::before {
            content: "DÖF Detay Raporu - " attr(data-dof-title);
            display: block;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
        }
    }
    
    /* Export dropdown stil iyileştirmeleri */
    .dropdown-menu .dropdown-item {
        padding: 0.5rem 1rem;
    }
    
    .dropdown-menu .dropdown-item i {
        width: 20px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<!-- Döküman Bilgileri -->
<div class="card border-0 shadow-sm mb-3">
    <div class="card-body p-2">
        <div class="d-flex justify-content-between align-items-center">
            <div class="me-auto">
                <span class="fw-bold">Döküman No:</span> P.03.F01.01
            </div>
            <div class="mx-4">
                <span class="fw-bold">Yayın Tarihi:</span> 01.08.2023
            </div>
            <div>
                <span class="fw-bold">Revizyon Tarihi:</span> 22.09.2023
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between mb-4">
    <div>
        <h1 class="h3">DÖF Detayı</h1>
        {% if dof.code %}
        <div class="badge bg-info text-dark fs-6 mb-2">Kod: {{ dof.code }}</div>
        {% else %}
        <div class="badge bg-secondary fs-6 mb-2">ID: {{ dof.id }}</div>
        {% endif %}
    </div>
    <div class="d-flex align-items-center">
        <!-- Yazdırma ve Dışa Aktarma Seçenekleri -->
        <div class="btn-group me-2" role="group">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-download me-1"></i> Dışa Aktar
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('dof.export_dof_detail_pdf', dof_id=dof.id) }}">
                    <i class="fas fa-file-pdf text-danger me-2"></i> PDF Olarak İndir
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('dof.export_dof_detail_excel', dof_id=dof.id) }}">
                    <i class="fas fa-file-excel text-success me-2"></i> Excel Olarak İndir
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="window.print()">
                    <i class="fas fa-print me-2"></i> Yazdır
                </a></li>
            </ul>
        </div>
        
        <a href="{{ url_for('dof.list_dofs') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> DÖF Listesine Dön
        </a>
        
        <!-- Düzenleme butonu: Taslak durumunda ve oluşturan kişi veya admin/kalite ise -->
        {% if (dof.status == 0 and dof.created_by == current_user.id) or current_user.role in [0, 2] %}
        <a href="{{ url_for('dof.edit_dof', dof_id=dof.id) }}" class="btn btn-info ms-2">
            <i class="fas fa-edit me-1"></i> Düzenle
        </a>
        {% endif %}
        
        <!-- Silme butonu: Yetkisi olan kullanıcılar için -->
        {% if dof.can_be_deleted_by(current_user) %}
        <button type="button" class="btn btn-danger ms-2" onclick="confirmDelete({{ dof.id }}, '{{ dof.code or ('DÖF #' + dof.id|string) }}')">
            <i class="fas fa-trash me-1"></i> Sil
        </button>
        {% endif %}

        <!-- İlk inceleme butonu: Taslak veya gönderildi durumundaki DÖF'ler için (sadece Kalite ve Admin) -->
        {% if current_user.role in [0, 2] and dof.status in [0, 1, 2] %}
        <a href="{{ url_for('dof.review_dof', dof_id=dof.id) }}" class="btn btn-primary ms-2 btn-lg">
            <i class="fas fa-search me-1"></i> İncele ve Ata
        </a>
        {% endif %}
        
        <!-- Departman Değiştir butonu: Kalite ve Admin için tüm ilgili durumlarda gösterilmeli -->
        {% if current_user.role in [0, 2] and dof.status in [0, 1, 2, 3, 4, 5, 8] %}
        <a href="{{ url_for('dof.review_dof', dof_id=dof.id) }}" class="btn btn-warning ms-2 btn-lg">
            <i class="fas fa-exchange-alt me-1"></i> Departman Değiştir
        </a>
        {% endif %}
        
        <!-- Son değerlendirme butonu: Çözüldü durumundaki DÖF'ler için (sadece Kalite ve Admin) -->
        {% if current_user.role in [0, 2] and dof.status == 5 %}
        <form action="{{ url_for('dof.close_dof', dof_id=dof.id) }}" method="GET" class="d-inline">
            <button type="submit" class="btn btn-success ms-2 btn-lg">
                <i class="fas fa-check-double me-1"></i> Çözümü Değerlendir ve Kapat
            </button>
        </form>
        {% endif %}
        
        <!-- Aksiyon planı inceleme butonu: PLANNING (8) durumundaki DÖF'ler için (sadece Kalite ve Admin) -->
        {% if current_user.role in [0, 2] and dof.status == 8 %}
        <a href="{{ url_for('dof.review_action_plan', dof_id=dof.id) }}" class="btn btn-primary ms-2 btn-lg">
            <i class="fas fa-clipboard-check me-1"></i> Aksiyon Planını İncele
        </a>
        {% endif %}

        <!-- Kök Neden ve Aksiyon Planı Gir butonu: Sadece departman yöneticileri (rol 4) ve adminler, DÖF atanmışsa -->
        {% if (current_user.role == 4 or current_user.role == 0) and dof.status == 3 and
              ((current_user.role == 4 and dof.department and current_user.department and current_user.department.id == dof.department.id) or current_user.role == 0) %}
        <a href="{{ url_for('dof.resolve_dof', dof_id=dof.id) }}" class="btn btn-success ms-2 btn-lg">
            <i class="fas fa-clipboard-check me-1"></i> Kök Neden ve Aksiyon Planı Gir
        </a>
        {% endif %}
        
        <!-- Revizyon Yanıtla butonu: Departman yöneticileri için, revizyon talep edilmişse -->
        {% if current_user.role == 4 and dof.status == 4 and dof.department and current_user.department and current_user.department.id == dof.department.id %}
        <a href="{{ url_for('dof.resolve_dof', dof_id=dof.id) }}" class="btn btn-warning ms-2 btn-lg">
            <i class="fas fa-edit me-1"></i> Revizyonu Yanıtla
        </a>
        {% endif %}
        
        <!-- Tamamlandı butonu - Atanan departman yöneticileri için (aksiyon planı hazırlandıktan veya onaylandıktan sonra) -->
        {% if (dof.status == 8 or dof.status == 9) and current_user.role == 4 and dof.department and current_user.department and current_user.department.id == dof.department.id %}
        <button type="button" class="btn btn-success ms-2 btn-lg" data-bs-toggle="modal" data-bs-target="#completeModal">
            <i class="fas fa-check-double me-1"></i> Tamamlandı
        </button>
        {% endif %}
        
        <!-- Kaynak departman değerlendirme butonları (DÖF'ü açan) -->
        {% if dof.status == 11 and (current_user.role == 0 or current_user.id == dof.created_by) %}
        <div class="d-inline-block">
            <form method="POST" action="{{ url_for('dof.add_dof_action', dof_id=dof.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="comment" value="DÖF çözümü kaynak departman tarafından onaylanmıştır.">
                <input type="hidden" name="new_status" value="5"> <!-- 5: Çözüldü -->
                <input type="hidden" name="is_source_satisfied" value="yes">
                <button type="submit" class="btn btn-success ms-2 btn-lg">
                    <i class="fas fa-check me-1"></i> Çözüldü
                </button>
            </form>
            
            <form method="POST" action="{{ url_for('dof.add_dof_action', dof_id=dof.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="comment" value="DÖF çözümünden kaynak departman memnun değil. Yeniden inceleme gerekmektedir.">
                <input type="hidden" name="new_status" value="4"> <!-- 4: Devam Ediyor / Çözüm Yetersiz -->
                <button type="submit" class="btn btn-warning ms-2 btn-lg">
                    <i class="fas fa-times-circle me-1"></i> Çözümden Memnun Değilim
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<!-- Görsel İş Akışı Rehberi -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="fas fa-route me-2"></i> DÖF Süreç Rehberi</h5>
    </div>
    <div class="card-body">
        <div class="progress-container mb-3">
            <ul class="progressbar">
                <li class="{{ 'active' if dof.status >= 0 or dof.status == 6 else '' }} {{ 'current' if dof.status == 0 else '' }}">1. Taslak</li>
                <li class="{{ 'active' if dof.status >= 1 or dof.status == 6 else '' }} {{ 'current' if dof.status in [1, 2] else '' }}">2. İnceleme</li>
                <li class="{{ 'active' if dof.status >= 3 or dof.status == 6 else '' }} {{ 'current' if dof.status in [3, 4] else '' }}">3. Atanmış</li>
                <li class="{{ 'active' if dof.status >= 8 or dof.status == 6 or dof.status == 5 else '' }} {{ 'current' if dof.status == 8 else '' }}">4. Aksiyon Planı</li>
                <li class="{{ 'active' if dof.status >= 9 or dof.status == 6 or dof.status == 5 else '' }} {{ 'current' if dof.status == 9 else '' }}">5. Uygulama</li>
                <li class="{{ 'active' if dof.status >= 10 or dof.status == 6 or dof.status == 5 else '' }} {{ 'current' if dof.status == 10 else '' }}">6. Tamamlandı</li>
                <li class="{{ 'active' if dof.status >= 11 or dof.status == 5 or dof.status == 6 else '' }} {{ 'current' if dof.status == 11 else '' }}">7. Kaynak Değerlendirmesi</li>
                <li class="{{ 'active' if dof.status == 5 or dof.status == 6 else '' }} {{ 'current' if dof.status == 5 else '' }}">8. Çözüldü</li>
                <li class="{{ 'active' if dof.status == 6 else '' }} {{ 'current' if dof.status == 6 else '' }}">9. Kapatıldı</li>
            </ul>
        </div>
        
        <!-- "Şu An Burasındasınız" göstergesi -->
        <div class="current-step-info mb-3">
            <h6 class="mb-2">
                <i class="fas fa-map-marker-alt me-2"></i> 
                Şu An Burasındasınız: 
                <span class="fw-bold status-highlight">{{ dof.status_name }}</span>
            </h6>
            
            {% if dof.status == 0 %}
            <p class="mb-0">DÖF taslak halinde. Gönderildiğinde kalite departmanı inceleyecek.</p>
            <p class="mb-0 mt-2 text-primary"><i class="fas fa-info-circle me-1"></i> <strong>Bir Sonraki Adım:</strong> DÖF'u göndermeniz gerekiyor.</p>
            
            {% elif dof.status == 1 %}
            <p class="mb-0">DÖF kalite departmanı tarafından inceleniyor. Onaylandığında bir departmana atanacak.</p>
            {% if current_user.role in [0, 2] %}<p class="mb-0 mt-2 text-primary"><i class="fas fa-info-circle me-1"></i> <strong>Bir Sonraki Adım:</strong> DÖF'u incelemeniz ve bir departmana atamanız gerekiyor.</p>{% endif %}
            
            {% elif dof.status == 2 %}
            <p class="mb-0">DÖF inceleme aşamasında ve bir departmana atanacak.</p>
            {% if current_user.role in [0, 2] %}<p class="mb-0 mt-2 text-primary"><i class="fas fa-info-circle me-1"></i> <strong>Bir Sonraki Adım:</strong> DÖF'u bir departmana atamanız gerekiyor.</p>{% endif %}
            
            {% elif dof.status == 3 %}
            <p class="mb-0">DÖF {{ dof.department.name }} departmanına atandı. Kök neden analizi ve aksiyon planı bekleniyor.</p>
            {% if current_user.role == 4 and current_user.department and current_user.department.id == dof.department.id %}<p class="mb-0 mt-2 text-primary"><i class="fas fa-info-circle me-1"></i> <strong>Bir Sonraki Adım:</strong> Kök neden analizi ve aksiyon planı girmeniz gerekiyor.</p>{% endif %}
            
            {% elif dof.status == 4 %}
            <p class="mb-0">DÖF için revizyon talep edildi. {{ dof.department.name }} departmanı tarafından revizyon yanıtı bekleniyor.</p>
            {% if current_user.role == 4 and current_user.department and current_user.department.id == dof.department.id %}<p class="mb-0 mt-2 text-primary"><i class="fas fa-info-circle me-1"></i> <strong>Bir Sonraki Adım:</strong> Revizyona yanıt vermeniz gerekiyor.</p>{% endif %}
            
            {% elif dof.status == 8 %}
            <p class="mb-0">Kök neden analizi ve aksiyon planı hazırlandı. Kalite departmanı tarafından inceleme bekleniyor.</p>
            {% if current_user.role in [0, 2] %}<p class="mb-0 mt-2 text-primary"><i class="fas fa-info-circle me-1"></i> <strong>Bir Sonraki Adım:</strong> Aksiyon planını incelemeniz ve onaylamanız gerekiyor.</p>{% endif %}
            
            {% elif dof.status == 9 %}
            <p class="mb-0">Aksiyon planı onaylanmış ve uygulama aşamasında. Sorumlu departman: {{ dof.department.name }}</p>
            {% if current_user.role == 4 and current_user.department and current_user.department.id == dof.department.id %}<p class="mb-0 mt-2 text-primary"><i class="fas fa-info-circle me-1"></i> <strong>Bir Sonraki Adım:</strong> Aksiyonları tamamladığınızda "Tamamlandı" butonuna tıklayın.</p>{% endif %}
            
            {% elif dof.status == 10 %}
            <p class="mb-0">
                <i class="fas fa-check-circle text-success me-1"></i>
                Aksiyonlar {{ dof.department.name }} departmanı tarafından tamamlandı. Kaynak departmanın onayı bekleniyor.
            </p>
            {% if (dof.creator and current_user.department_id == dof.creator.department_id) or current_user.id == dof.created_by %}
                <p class="mb-0 mt-2 text-primary"><i class="fas fa-info-circle me-1"></i> <strong>Bir Sonraki Adım:</strong> Çözümü onaylamanız veya reddetmeniz gerekiyor.</p>
            {% endif %}
                         <!-- Tamamlama detaylarını göster -->
             {% set completion_action = none %}
             {% for action in dof.actions %}
                 {% if action.new_status == 10 and not completion_action %}
                     {% set completion_action = action %}
                 {% endif %}
             {% endfor %}
             {% if completion_action %}
             <div class="mt-2 p-2 bg-success bg-opacity-10 border border-success rounded">
                 <small class="text-success fw-bold">
                     <i class="fas fa-calendar-check me-1"></i>
                     Tamamlama Tarihi: {{ completion_action.created_at.strftime('%d.%m.%Y %H:%M') }}
                 </small>
                 {% if completion_action.attachments %}
                 <div class="mt-1">
                     <small class="text-success">
                         <i class="fas fa-paperclip me-1"></i>
                         {{ completion_action.attachments|length }} kanıt dosyası eklendi
                     </small>
                 </div>
                 {% endif %}
             </div>
             {% endif %}
            
            {% elif dof.status == 5 %}
            <p class="mb-0">Kaynak departman çözümü onayladı. Son kapanış değerlendirmesi için kalite yöneticisinin onayı bekleniyor.</p>
            {% if current_user.role in [0, 2] %}<p class="mb-0 mt-2 text-primary"><i class="fas fa-info-circle me-1"></i> <strong>Bir Sonraki Adım:</strong> Çözümü değerlendirip kapatmanız gerekiyor.</p>{% endif %}
            
            {% elif dof.status == 6 %}
            <p class="mb-0">DÖF başarıyla kapatıldı. Tüm süreç tamamlandı.</p>
            
            {% elif dof.status == 7 %}
            <p class="mb-0">DÖF reddedildi.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- İş Akışı Bilgilendirmeleri -->
{% if dof.status == 0 %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle me-2"></i> Bu DÖF Kalite onayındadır. Kalite departmanı tarafından değerlendirilecektir. <strong>Departman ataması bekleniyor.</strong>
</div>
{% elif dof.status == 1 %}
<div class="alert alert-warning mb-4">
    <i class="fas fa-hourglass-half me-1"></i> Bu DÖF Kalite Departmanı tarafından değerlendirilmeyi ve <strong>departman ataması yapılmasını</strong> bekliyor.
</div>
{% elif dof.status == 2 %}
<div class="alert alert-primary mb-4">
    <i class="fas fa-spinner me-1"></i> Bu DÖF şu anda kalite departmanı tarafından inceleniyor.
</div>
{% elif dof.status == 3 %}
<div class="alert alert-secondary mb-4">
    <i class="fas fa-people-arrows me-1"></i> Bu DÖF {{ dof.department.name }} departmanına atandı. Kök neden analizi ve aksiyon planının oluşturulması bekleniyor.
</div>
{% elif dof.status == 8 %}
<div class="alert alert-warning mb-4">
    <i class="fas fa-project-diagram me-1"></i> Kök neden analizi ve aksiyon planı hazırlandı. Kalite departmanı tarafından inceleme bekleniyor.
</div>
{% elif dof.status == 9 %}
<div class="alert alert-info mb-4">
    <i class="fas fa-cogs me-1"></i> Aksiyon planı onaylanmış ve uygulama aşamasında. Sorumlu departman: {{ dof.department.name }}
</div>
{% elif dof.status == 10 %}
<div class="alert alert-success mb-4">
    <i class="fas fa-check-circle me-1"></i> 
    <strong>Aksiyon planları tamamlandı!</strong> 
    {{ dof.department.name }} departmanı tarafından tüm aksiyonlar tamamlanmıştır. Kaynak departmanın onayı bekleniyor.
</div>
{% elif dof.status == 11 %}
<div class="alert alert-info mb-4">
    <i class="fas fa-search me-1"></i> Bu DÖF kaynak departman değerlendirmesinde. Son kapatma işlemi için kalite departmanının değerlendirmesi beklenecek.
</div>
{% elif dof.status == 5 %}
<div class="alert alert-success mb-4">
    <i class="fas fa-check me-1"></i> Bu DÖF kaynak departman tarafından onaylandı. Kalite departmanı tarafından son inceleme bekleniyor.
</div>
{% elif dof.status == 6 %}
<div class="alert alert-success mb-4">
    <i class="fas fa-check-double me-1"></i> Bu DÖF başarıyla tamamlandı ve kapatıldı.
</div>
{% elif dof.status == 7 %}
<div class="alert alert-danger mb-4">
    <i class="fas fa-times-circle me-1"></i> Bu DÖF reddedildi.
</div>
{% elif dof.status == 4 %}
<div class="alert alert-warning mb-4">
    <i class="fas fa-exclamation-triangle me-1"></i> Bu DÖF üzerinde yeniden çalışma gerekiyor. Sorumlu departman: {{ dof.department.name }}
</div>
{% endif %}

<!-- DÖF Detay Kartı -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <span class="badge bg-primary me-2">#{{ dof.id }}</span> {{ dof.title }}
            </h5>
            <div>
                {% if dof.status == 0 %}
                    <span class="badge bg-secondary">Taslak</span>
                {% elif dof.status == 1 %}
                    <span class="badge bg-info">Gönderildi</span>
                {% elif dof.status == 2 %}
                    <span class="badge bg-primary">İncelemede</span>
                {% elif dof.status == 3 %}
                    <span class="badge bg-warning">Atandı</span>
                {% elif dof.status == 4 %}
                    <span class="badge bg-info">Devam Ediyor</span>
                {% elif dof.status == 5 %}
                    <span class="badge bg-success">Çözüldü</span>
                {% elif dof.status == 6 %}
                    <span class="badge bg-success">Kapatıldı</span>
                {% elif dof.status == 7 %}
                    <span class="badge bg-danger">Reddedildi</span>
                {% elif dof.status == 8 %}
                    <span class="badge bg-warning">Aksiyon Planı İncelemede</span>
                {% elif dof.status == 9 %}
                    <span class="badge bg-info">Aksiyon Planı Uygulama Aşamasında</span>
                {% elif dof.status == 10 %}
                    <span class="badge bg-success">Aksiyonlar Tamamlandı</span>
                {% elif dof.status == 11 %}
                    <span class="badge bg-info">Kaynak Değerlendirmesinde</span>
                {% endif %}
                <span class="badge bg-secondary ml-2">{{ dof.created_at.strftime('%d.%m.%Y') }}</span>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Temel DÖF Bilgileri (Modern Tasarım) -->
        <div class="mb-4">
            <div class="row mb-4">
                <!-- DÖF Başlık ve Durum -->
                <div class="col-12 mb-3">
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
                        <div>
                            <h5 class="mb-1">{{ dof.title }}</h5>
                            <p class="text-muted mb-0 small">
                                <i class="fas fa-calendar-alt me-1"></i> {{ dof.created_at.strftime('%d.%m.%Y %H:%M') }}
                                {% if dof.updated_at and dof.updated_at != dof.created_at %}
                                <span class="mx-1">|</span> 
                                <i class="fas fa-edit me-1"></i> Son Güncelleme: {{ dof.updated_at.strftime('%d.%m.%Y %H:%M') }}
                                {% endif %}
                            </p>
                        </div>
                        <div>
                            {% if dof.status == 0 %}
                                <span class="badge bg-secondary py-2 px-3">Taslak</span>
                            {% elif dof.status == 1 %}
                                <span class="badge bg-info py-2 px-3">Gönderildi</span>
                            {% elif dof.status == 2 %}
                                <span class="badge bg-primary py-2 px-3">İncelemede</span>
                            {% elif dof.status == 3 %}
                                <span class="badge bg-warning py-2 px-3">Atandı</span>
                            {% elif dof.status == 4 %}
                                <span class="badge bg-info py-2 px-3">Devam Ediyor</span>
                            {% elif dof.status == 5 %}
                                <span class="badge bg-success py-2 px-3">Çözüldü</span>
                            {% elif dof.status == 6 %}
                                <span class="badge bg-success py-2 px-3">Kapatıldı</span>
                            {% elif dof.status == 7 %}
                                <span class="badge bg-danger py-2 px-3">Reddedildi</span>
                            {% elif dof.status == 8 %}
                                <span class="badge bg-warning py-2 px-3">Aksiyon Planı İncelemede</span>
                            {% elif dof.status == 9 %}
                                <span class="badge bg-info py-2 px-3">Aksiyon Planı Uygulama Aşamasında</span>
                            {% elif dof.status == 10 %}
                                <span class="badge bg-success py-2 px-3">Aksiyonlar Tamamlandı</span>
                            {% elif dof.status == 11 %}
                                <span class="badge bg-info py-2 px-3">Kaynak Değerlendirmesinde</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="row gx-4">
                <!-- Sol Bilgiler: Kaynak ve oluşturucu bilgileri -->
                <div class="col-md-6 mb-3">
                    <div class="p-3 bg-light rounded h-100">
                        <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-file-alt me-2"></i> Kaynak Bilgileri</h6>
                        <div class="row">
                            <div class="col-sm-6 mb-2">
                                <p class="text-muted mb-1 small">Oluşturan</p>
                                <p class="mb-0"><strong>{{ dof.creator.full_name }}</strong></p>
                            </div>
                            <div class="col-sm-6 mb-2">
                                <p class="text-muted mb-1 small">Kaynak Departman</p>
                                <p class="mb-0"><strong>{{ dof.creator.department.name if dof.creator.department else 'Belirtilmemiş' }}</strong></p>
                            </div>
                            <div class="col-sm-6 mb-2">
                                <p class="text-muted mb-1 small">Tür</p>
                                <p class="mb-0"><strong>{% if dof.dof_type == 1 %}Düzeltici Faaliyet{% elif dof.dof_type == 2 %}Önleyici Faaliyet{% else %}Belirtilmemiş{% endif %}</strong></p>
                            </div>
                            <div class="col-sm-6 mb-2">
                                <p class="text-muted mb-1 small">DOF Kaynağı</p>
                                <p class="mb-0"><strong>{% if dof.dof_source == 1 %}İç Denetim{% elif dof.dof_source == 2 %}Dış Denetim{% elif dof.dof_source == 3 %}Müşteri Şikayeti{% elif dof.dof_source == 4 %}Çalışan Önerisi{% elif dof.dof_source == 5 %}Uygunsuzluk{% elif dof.dof_source == 6 %}Diğer{% else %}Belirtilmemiş{% endif %}</strong></p>
                            </div>
                            
                            {% if dof.dof_source == 3 %}
                            <!-- Müşteri şikayeti kaynaklı ise kanal bilgisi göster -->
                            <div class="col-sm-6 mb-2">
                                <p class="text-muted mb-1 small">Şikayet Kanalı</p>
                                <p class="mb-0"><strong>{{ dof.channel if dof.channel else 'Belirtilmemiş' }}</strong></p>
                            </div>
                            <!-- Müşteri şikayeti kaynaklı ise şikayet tarihi göster -->
                            <div class="col-sm-6 mb-2">
                                <p class="text-muted mb-1 small">Şikayet Tarihi</p>
                                <p class="mb-0"><strong>{{ dof.complaint_date.strftime('%d.%m.%Y') if dof.complaint_date else 'Belirtilmemiş' }}</strong></p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!-- Sağ Bilgiler: Atama bilgileri -->
                <div class="col-md-6 mb-3">
                    <div class="p-3 bg-light rounded h-100">
                        <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-tasks me-2"></i> Atama Bilgileri</h6>
                        <div class="row">
                            <div class="col-sm-6 mb-2">
                                <p class="text-muted mb-1 small">Atanan Departman</p>
                                <p class="mb-0"><strong>{{ dof.department.name if dof.department else 'Henüz atanmadı' }}</strong></p>
                            </div>
                            <div class="col-sm-6 mb-2">
                                <p class="text-muted mb-1 small">Atayan</p>
                                <p class="mb-0"><strong>Kalite Yöneticisi</strong></p>
                            </div>
                            <div class="col-sm-6 mb-2">
                                <p class="text-muted mb-1 small">Atama Tarihi</p>
                                <p class="mb-0"><strong>{{ dof.created_at|format_datetime }}</strong></p>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <!-- Alt Bilgi: Zaman bilgileri -->
                <div class="col-12">
                    <div class="bg-light rounded p-3">
                        <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-clock me-2"></i> Zaman Bilgileri</h6>
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <p class="text-muted mb-1 small">Son Tarih <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="DÖF'ün incelenmesi gereken son tarih"></i></p>
                                <p class="mb-0"><strong>{{ dof.due_date.strftime('%d.%m.%Y') if dof.due_date else 'Belirtilmemiş' }}</strong></p>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <p class="text-muted mb-1 small">Termin <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Aksiyon planının tamamlanması gereken tarih"></i></p>
                                <p class="mb-0"><strong>{{ dof.deadline.strftime('%d.%m.%Y') if dof.deadline else 'Belirtilmemiş' }}</strong></p>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <p class="text-muted mb-1 small">Kalan Süre <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Termine kalan süre (sadece devam eden DÖF'ler için)"></i></p>
                                <p class="mb-0">
                                    {% if dof.status in [6, 7] %}
                                        <!-- Kapalı veya reddedilmiş DÖF'ler için -->
                                        <span class="badge bg-secondary">Tamamlandı</span>
                                                                         {% elif dof.deadline %}
                                         <!-- Termin tarihi varsa kalan süreyi hesapla -->
                                         {% set days_left = (dof.deadline.date() - now.date()).days %}
                                        {% if days_left < 0 %}
                                            <span class="badge bg-danger">{{ days_left * -1 }} gün geçti</span>
                                        {% elif days_left == 0 %}
                                            <span class="badge bg-warning">Bugün</span>
                                        {% elif days_left <= 3 %}
                                            <span class="badge bg-warning">{{ days_left }} gün kaldı</span>
                                        {% elif days_left <= 7 %}
                                            <span class="badge bg-info">{{ days_left }} gün kaldı</span>
                                        {% else %}
                                            <span class="badge bg-success">{{ days_left }} gün kaldı</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">Termin belirlenmemiş</span>
                                    {% endif %}
                                </p>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DÖF Açıklaması ve İçeriği -->
        <div class="mb-4">
            <h6 class="fw-bold mb-3">Uygunsuzluk Açıklaması</h6>
            <div class="border rounded p-3 bg-light">
                {{ dof.description|safe|nl2br }}
            </div>
        </div>

        <!-- Kök Neden ve Aksiyon Planı -->
        {% if dof.root_cause1 or dof.root_cause2 or dof.root_cause3 or dof.root_cause4 or dof.root_cause5 or dof.action_plan %}
        <div class="mb-4">
            <h6 class="fw-bold mb-3">Kök Neden Analizi (5 Neden Tekniği)</h6>
            
            {% if dof.root_cause1 %}
            <div class="mb-2">
                <small class="text-muted fw-bold">1. Neden:</small>
                <div class="border rounded p-3 bg-light">
                    {{ dof.root_cause1|safe|nl2br }}
                </div>
            </div>
            {% endif %}
            
            {% if dof.root_cause2 %}
            <div class="mb-2">
                <small class="text-muted fw-bold">2. Neden:</small>
                <div class="border rounded p-3 bg-light">
                    {{ dof.root_cause2|safe|nl2br }}
                </div>
            </div>
            {% endif %}
            
            {% if dof.root_cause3 %}
            <div class="mb-2">
                <small class="text-muted fw-bold">3. Neden:</small>
                <div class="border rounded p-3 bg-light">
                    {{ dof.root_cause3|safe|nl2br }}
                </div>
            </div>
            {% endif %}
            
            {% if dof.root_cause4 %}
            <div class="mb-2">
                <small class="text-muted fw-bold">4. Neden:</small>
                <div class="border rounded p-3 bg-light">
                    {{ dof.root_cause4|safe|nl2br }}
                </div>
            </div>
            {% endif %}
            
            {% if dof.root_cause5 %}
            <div class="mb-3">
                <small class="text-muted fw-bold">5. Neden (Kök Neden):</small>
                <div class="border rounded p-3 bg-light">
                    {{ dof.root_cause5|safe|nl2br }}
                </div>
            </div>
            {% endif %}
            
            {% if not (dof.root_cause1 or dof.root_cause2 or dof.root_cause3 or dof.root_cause4 or dof.root_cause5) %}
            <div class="border rounded p-3 bg-light mb-3 text-muted">
                Henüz kök neden analizi girilmedi
            </div>
            {% endif %}

            <h6 class="fw-bold mb-3">Aksiyon Planı</h6>
            <div class="border rounded p-3 bg-light">
                {{ dof.action_plan|safe|nl2br if dof.action_plan else 'Henüz girilmedi' }}
            </div>
        </div>
        {% endif %}

        <!-- Çözüm -->
        {% if dof.resolution %}
        <div class="mb-4">
            <h6 class="fw-bold mb-3">Çözüm</h6>
            <div class="border rounded p-3 bg-light">
                {{ dof.resolution|safe|nl2br }}
            </div>
        </div>
        {% endif %}

        <!-- Ekler -->
        {% if dof.attachments %}
        <div class="mb-4">
            <h6 class="fw-bold mb-3">Ekler</h6>
            <div class="list-group">
                {% for attachment in dof.attachments %}
                {% set file_ext = attachment.filename.split('.')[-1]|lower %}
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-file me-2"></i> {{ attachment.filename }}
                        <small class="text-muted ms-2">({{ attachment.file_size|filesizeformat }})</small>
                    </div>
                    <div>
                        {% if file_ext in ['pdf', 'png', 'jpg', 'jpeg'] %}
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#previewModal{{ attachment.id }}">
                            <i class="fas fa-eye"></i> Önizleme
                        </button>
                        {% endif %}
                        <a href="{{ url_for('dof.download_attachment', dof_id=dof.id, attachment_id=attachment.id) }}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-download"></i> İndir
                        </a>
                    </div>
                </div>
                
                {% if file_ext in ['pdf', 'png', 'jpg', 'jpeg'] %}
                <!-- Önizleme Modal -->
                <div class="modal fade" id="previewModal{{ attachment.id }}" tabindex="-1" aria-labelledby="previewModalLabel{{ attachment.id }}" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="previewModalLabel{{ attachment.id }}">{{ attachment.filename }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                            </div>
                            <div class="modal-body text-center">
                                {% if file_ext == 'pdf' %}
                                <iframe src="{{ url_for('dof.preview_attachment', dof_id=dof.id, attachment_id=attachment.id) }}" width="100%" height="600px" style="border: none;"></iframe>
                                {% else %}
                                <img src="{{ url_for('dof.preview_attachment', dof_id=dof.id, attachment_id=attachment.id) }}" class="img-fluid" alt="{{ attachment.filename }}">
                                {% endif %}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                                <a href="{{ url_for('dof.download_attachment', dof_id=dof.id, attachment_id=attachment.id) }}" class="btn btn-primary">
                                    <i class="fas fa-download me-1"></i> İndir
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- İşlem Geçmişi -->
        <div class="mb-4">
            <h6 class="fw-bold mb-3">İşlem Geçmişi</h6>
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Tarih</th>
                            <th>Kullanıcı</th>
                            <th>İşlem Tipi</th>
                            <th>Açıklama</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for action in dof.actions|sort(attribute='created_at', reverse=True) %}
                        <tr>
                            <td>{{ action.created_at|format_datetime }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <span class="avatar-badge me-2 bg-{{ ['primary', 'success', 'warning', 'info', 'danger']|random }}">
                                        {{ action.user.full_name[0]|upper }}
                                    </span>
                                    {{ action.user.full_name }}
                                </div>
                            </td>
                            <td>
                                {% if action.old_status is not none and action.new_status is not none %}
                                    {% if action.new_status == 10 %}
                                        <span class="badge bg-success">Tamamlandı</span>
                                        <div class="small text-muted mt-1">{{ action.old_status|get_status_name }} &rarr; Aksiyonlar Tamamlandı</div>
                                    {% else %}
                                        <span class="badge bg-primary">Durum Değişikliği</span>
                                        <div class="small text-muted mt-1">{{ action.old_status|get_status_name }} &rarr; {{ action.new_status|get_status_name }}</div>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-info">İşlem</span>
                                {% endif %}
                            </td>
                            <td>
                                <div>
                                    {% if action.comment %}
                                        {% if action.new_status == 10 %}
                                            <!-- Tamamlandı aşaması için özel gösterim -->
                                            <div class="alert alert-success py-2 px-3 mb-1">
                                                <i class="fas fa-check-circle me-1"></i>
                                                <strong>Aksiyon Tamamlandı</strong>
                                            </div>
                                            <div class="small">{{ action.comment|truncate(100) }}</div>
                                        {% else %}
                                            {{ action.comment|truncate(60) }}
                                        {% endif %}
                                        {% if action.comment|length > (100 if action.new_status == 10 else 60) %}
                                            <button class="btn btn-sm btn-link p-0" type="button" data-bs-toggle="modal" data-bs-target="#commentModal{{ action.id }}">
                                                Detay
                                            </button>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </div>
                                
                                <!-- Yorum ekleri varsa göster -->
                                {% if action.attachments %}
                                <div class="mt-2">
                                    {% if action.new_status == 10 %}
                                        <small class="text-success fw-bold"><i class="fas fa-file-check me-1"></i>Kanıt Dosyaları:</small>
                                    {% else %}
                                        <small class="text-muted">Ekler:</small>
                                    {% endif %}
                                    {% for attachment in action.attachments %}
                                    {% set file_ext = attachment.filename.split('.')[-1]|lower %}
                                    <div class="d-inline-block me-2 mt-1">
                                        {% if action.new_status == 10 %}
                                            <!-- Tamamlandı aşaması için özel butonlar -->
                                            <div class="btn-group" role="group">
                                                {% if file_ext in ['pdf', 'png', 'jpg', 'jpeg'] %}
                                                <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#previewActionModal{{ action.id }}_{{ attachment.id }}" title="Önizleme: {{ attachment.filename }}">
                                                    <i class="fas fa-eye me-1"></i>{{ attachment.filename|truncate(12) }}
                                                </button>
                                                {% endif %}
                                                <a href="{{ url_for('dof.download_action_attachment', dof_id=dof.id, action_id=action.id, attachment_id=attachment.id) }}" 
                                                   class="btn btn-sm btn-success" title="İndir: {{ attachment.filename }}">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                            </div>
                                        {% else %}
                                            <!-- Normal yorum ekleri için basit buton -->
                                            <a href="{{ url_for('dof.download_action_attachment', dof_id=dof.id, action_id=action.id, attachment_id=attachment.id) }}" 
                                               class="btn btn-sm btn-outline-secondary" title="{{ attachment.filename }}">
                                                <i class="fas fa-paperclip me-1"></i>{{ attachment.filename|truncate(15) }}
                                            </a>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                <!-- Yorum Modal -->
                                {% if action.comment and action.comment|length > 60 %}
                                <div class="modal fade" id="commentModal{{ action.id }}" tabindex="-1" aria-labelledby="commentModalLabel{{ action.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="commentModalLabel{{ action.id }}">İşlem Detayı</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p class="text-muted mb-1">{{ action.created_at.strftime('%d.%m.%Y %H:%M') }} - {{ action.user.full_name }}</p>
                                                <p>{{ action.comment|nl2br }}</p>
                                                
                                                <!-- Modal içinde de ekleri göster -->
                                                {% if action.attachments %}
                                                <hr>
                                                <h6>Ekler:</h6>
                                                {% for attachment in action.attachments %}
                                                <div class="mb-2">
                                                    <a href="{{ url_for('dof.download_action_attachment', dof_id=dof.id, action_id=action.id, attachment_id=attachment.id) }}" 
                                                       class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-download me-1"></i>{{ attachment.filename }}
                                                    </a>
                                                    <small class="text-muted ms-2">({{ attachment.file_size|filesizeformat }})</small>
                                                </div>
                                                {% endfor %}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Tamamlandı Dosya Önizleme Modalları -->
                                {% if action.new_status == 10 and action.attachments %}
                                    {% for attachment in action.attachments %}
                                        {% set file_ext = attachment.filename.split('.')[-1]|lower %}
                                        {% if file_ext in ['pdf', 'png', 'jpg', 'jpeg'] %}
                                        <div class="modal fade" id="previewActionModal{{ action.id }}_{{ attachment.id }}" tabindex="-1" aria-labelledby="previewActionModalLabel{{ action.id }}_{{ attachment.id }}" aria-hidden="true">
                                            <div class="modal-dialog modal-xl modal-dialog-centered">
                                                <div class="modal-content">
                                                    <div class="modal-header bg-success text-white">
                                                        <h5 class="modal-title" id="previewActionModalLabel{{ action.id }}_{{ attachment.id }}">
                                                            <i class="fas fa-file-check me-2"></i>Kanıt Dosyası: {{ attachment.filename }}
                                                        </h5>
                                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
                                                    </div>
                                                    <div class="modal-body text-center p-4">
                                                        {% if file_ext == 'pdf' %}
                                                        <iframe src="{{ url_for('dof.download_action_attachment', dof_id=dof.id, action_id=action.id, attachment_id=attachment.id) }}" 
                                                                width="100%" height="600px" style="border: none; border-radius: 8px;"></iframe>
                                                        {% else %}
                                                        <img src="{{ url_for('dof.download_action_attachment', dof_id=dof.id, action_id=action.id, attachment_id=attachment.id) }}" 
                                                             class="img-fluid rounded shadow" alt="{{ attachment.filename }}" style="max-height: 70vh;">
                                                        {% endif %}
                                                    </div>
                                                    <div class="modal-footer">
                                                        <div class="me-auto">
                                                            <small class="text-muted">
                                                                <i class="fas fa-info-circle me-1"></i>
                                                                Boyut: {{ attachment.file_size|filesizeformat }} | 
                                                                Tarih: {{ action.created_at.strftime('%d.%m.%Y %H:%M') }}
                                                            </small>
                                                        </div>
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                            <i class="fas fa-times me-1"></i>Kapat
                                                        </button>
                                                        <a href="{{ url_for('dof.download_action_attachment', dof_id=dof.id, action_id=action.id, attachment_id=attachment.id) }}" 
                                                           class="btn btn-success">
                                                            <i class="fas fa-download me-1"></i>İndir
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Yorum Bölümü -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0">Yorumlar</h5>
    </div>
    <div class="card-body">
        <!-- Yorumlar -->
        {% if dof.comments %}
        <div class="mb-4">
            {% for comment in dof.comments|sort(attribute='created_at') %}
            <div class="d-flex mb-3">
                <div class="flex-shrink-0">
                    <div class="avatar bg-light rounded-circle d-flex justify-content-center align-items-center">
                        <span class="h4 mb-0">{{ comment.user.fullname[0]|upper }}</span>
                    </div>
                </div>
                <div class="flex-grow-1 ms-3">
                    <div class="bg-light rounded p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">{{ comment.user.full_name }}</h6>
                            <small class="text-muted">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                        </div>
                        <p class="mb-0">{{ comment.comment|safe|nl2br }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">Henüz yorum yapılmamış.</p>
        {% endif %}

        <!-- Yorum Formu -->
        <form method="POST" action="{{ url_for('dof.add_dof_action', dof_id=dof.id) }}" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
                <label for="comment" class="form-label fw-bold">Yorum Ekle</label>
                <textarea class="form-control" id="comment" name="comment" rows="3" required></textarea>
            </div>
            <div class="mb-3">
                <label for="action_files" class="form-label fw-bold">Dosya Ekle (İsteğe bağlı)</label>
                <input type="file" class="form-control" id="action_files" name="action_files" multiple accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.xls,.xlsx">
                <div class="form-text">İzin verilen dosya tipleri: PDF, PNG, JPG, DOC, DOCX, XLS, XLSX (Max: 16MB)</div>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane me-1"></i> Gönder
            </button>
        </form>
    </div>
</div>
<!-- Tamamlandı Modal -->
{% if (dof.status == 8 or dof.status == 9) and current_user.role == 4 and dof.department and current_user.department and current_user.department.id == dof.department.id %}
<div class="modal fade" id="completeModal" tabindex="-1" aria-labelledby="completeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="completeModalLabel">
                    <i class="fas fa-check-double me-2"></i>Aksiyonları Tamamlandı Olarak İşaretle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('dof.mark_as_completed', dof_id=dof.id) }}" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Bu işlem, DÖF için belirlenen tüm aksiyonları tamamladığınızı ve kaynak departmanın incelemesine gönderdiğinizi belirtir.
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="fw-bold">DÖF Bilgileri</h6>
                        <div class="bg-light p-3 rounded">
                            <p class="mb-1"><strong>DÖF:</strong> #{{ dof.id }} - {{ dof.title }}</p>
                            <p class="mb-1"><strong>Departman:</strong> {{ dof.department.name }}</p>
                            <p class="mb-0"><strong>Durum:</strong> 
                                {% if dof.status == 8 %}
                                    <span class="badge bg-warning">Aksiyon Planı İncelemede</span>
                                {% else %}
                                    <span class="badge bg-info">Aksiyon Planı Uygulama Aşamasında</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="completion_comment" class="form-label fw-bold">
                            Tamamlama Detayları <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="completion_comment" name="comment" rows="4" required 
                                  placeholder="Hangi aksiyonların tamamlandığını, ne gibi sonuçlar elde edildiğini ve varsa ek bilgileri detaylı olarak açıklayınız...">Aksiyon planında belirtilen tüm faaliyetler {{ current_user.department.name }} departmanı tarafından başarıyla tamamlanmıştır.</textarea>
                        <div class="form-text">Bu açıklama kaynak departman tarafından incelenecektir.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="completion_attachments" class="form-label fw-bold">
                            Kanıt Dosyaları <small class="text-muted">(İsteğe bağlı)</small>
                        </label>
                        <input type="file" class="form-control" id="completion_attachments" name="attachments" multiple 
                               accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.xls,.xlsx">
                        <div class="form-text">
                            Tamamlanan aksiyonları kanıtlayan belgeler ekleyebilirsiniz. 
                            İzin verilen dosya tipleri: PDF, PNG, JPG, DOC, DOCX, XLS, XLSX (Max: 16MB)
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Dikkat:</strong> Bu işlem geri alınamaz. Tamamlandı olarak işaretlendikten sonra DÖF kaynak departmanın değerlendirmesine gönderilecektir.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>İptal
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check-double me-1"></i>Tamamlandı Olarak İşaretle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock content %}

{% block extra_js %}
<script>
    // Doküman yüklendiğinde gerekli bileşenleri başlat
    document.addEventListener('DOMContentLoaded', function() {
        // Select2 başlat
        $('.user-select, .select2').select2({
            theme: 'bootstrap4',
            placeholder: 'Kullanıcı seçiniz',
            allowClear: true,
            language: 'tr',
            width: '100%'
        });
        
        // DÖF süreç rehberini server-side render ettik, JS'e gerek yok
        // updateProgressBar("{{ dof.status }}");
    });
    
    // DÖF durumuna göre ilerleme çubuğunu güncelle
    function updateProgressBar(status) {
        const statusMap = {
            "0": 1,  // Taslak
            "1": 2,  // Gönderildi
            "2": 2,  // İnceleniyor
            "3": 3,  // Atandı
            "4": 3,  // Aksiyon Planı Reddedildi
            "8": 4,  // Aksiyon Planı Hazırlanıyor
            "9": 5,  // Aksiyon Planı Onaylandı (Uygulama)
            "10": 6, // Tamamlandı
            "11": 7, // Kaynak Değerlendirmesi
            "5": 8,  // Çözüldü
            "6": 9,  // Kapatıldı
            "7": 3  // Reddedildi
        };
        
        const stepNo = statusMap[status] || 1;
        
        // Tüm adımları temizle
        document.querySelectorAll('.progressbar li').forEach((item, index) => {
            item.classList.remove('active', 'current');
            
            // Aktif adımları işaretle
            if (index < stepNo - 1) {
                item.classList.add('active');
            }
            
            // Mevcut adımı işaretle
            if (index === stepNo - 1) {
                item.classList.add('current', 'active');
            }
        });
        
        // Mevcut adım için ekstra bilgi göster
        document.querySelectorAll('.step-info').forEach(info => {
            info.style.display = 'none';
        });
        
        const currentInfo = document.getElementById('step-info-' + stepNo);
        if (currentInfo) {
            currentInfo.style.display = 'block';
        }
    }
    
    // DÖF silme onay dialog'u
    function confirmDelete(dofId, dofCode) {
        if (confirm('Bu DÖF\'ü silmek istediğinizden emin misiniz?\n\n' + dofCode + '\n\nBu işlem geri alınamaz!')) {
            // Silme formu oluştur ve gönder
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/dof/' + dofId + '/delete';
            
            // CSRF token ekle
            const csrfToken = document.querySelector('meta[name=csrf-token]');
            if (csrfToken) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'csrf_token';
                tokenInput.value = csrfToken.getAttribute('content');
                form.appendChild(tokenInput);
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock extra_js %}
